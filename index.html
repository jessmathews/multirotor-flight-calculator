<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Multirotor Flight Time Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }

        .input-section, .results-section {
            padding: 30px;
        }

        .input-section {
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
        }

        .mode-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 600;
        }

        .mode-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .calc-mode-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 25px;
        }

        .calc-mode-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 0.9rem;
        }

        .calc-mode-btn.ideal { border-color: #28a745; }
        .calc-mode-btn.realistic { border-color: #ffc107; }
        .calc-mode-btn.conservative { border-color: #dc3545; }

        .calc-mode-btn.active.ideal { background: #28a745; color: white; }
        .calc-mode-btn.active.realistic { background: #ffc107; color: white; }
        .calc-mode-btn.active.conservative { background: #dc3545; color: white; }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .tooltip {
            display: inline-block;
            margin-left: 5px;
            width: 16px;
            height: 16px;
            background: #6c757d;
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 12px;
            line-height: 16px;
            cursor: help;
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            white-space: nowrap;
            z-index: 1000;
            font-size: 11px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .results-section {
            background: white;
        }

        .flight-time-display {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-radius: 15px;
            color: white;
        }

        .flight-time-value {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .flight-time-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .results-tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .results-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .results-tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .power-breakdown {
            margin-bottom: 20px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1rem;
            color: #007bff;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }

        .warning.danger {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .warning-icon {
            display: inline-block;
            margin-right: 8px;
            font-weight: bold;
        }

        .advanced-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid #e9ecef;
            display: none;
        }

        .advanced-section.show {
            display: block;
        }

        .advanced-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .advanced-toggle:hover {
            background: #5a6268;
        }

        .export-section {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .export-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
            transition: background 0.3s;
        }

        .export-btn:hover {
            background: #138496;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        @media (max-width:638px) {
            .results-tabs {
                flex-wrap: nowrap;
                overflow: auto;
                -webkit-overflow-scrolling: touch;
            }
            
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .input-section {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .flight-time-value {
                font-size: 2rem;
            }

            .header h1 {
                font-size: 1.8rem;
            }
        }

        .credit {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            color: #6c757d;
        }

        .credit a {
            color: #007bff;
            text-decoration: none;
        }

        .credit a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÅ Professional Multirotor Flight Time Calculator</h1>
            <p>Engineering-grade accuracy for professional drone operations</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <div class="mode-selector">
                    <div class="mode-btn active" data-mode="beginner">üî∞ Beginner</div>
                    <div class="mode-btn" data-mode="advanced">‚öôÔ∏è Advanced</div>
                </div>

                <div class="calc-mode-selector">
                    <div class="calc-mode-btn ideal active" data-calc="ideal">üü¢ Ideal</div>
                    <div class="calc-mode-btn realistic" data-calc="realistic">üü° Realistic</div>
                    <div class="calc-mode-btn conservative" data-calc="conservative">üî¥ Conservative</div>
                </div>

                <form id="calculatorForm">
                    <div class="form-group">
                        <label>Aircraft Configuration <span class="tooltip" data-tooltip="Number of motors/propellers">?</span></label>
                        <select class="form-control" id="aircraftType">
                            <option value="4">Quadcopter (4 motors)</option>
                            <option value="6">Hexacopter (6 motors)</option>
                            <option value="8">Octocopter (8 motors)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>

                    <div class="form-group" id="customMotorGroup" style="display:none;">
                        <label>Number of Motors</label>
                        <input type="number" class="form-control" id="customMotorCount" min="3" max="12" value="4">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Total Weight (kg) <span class="tooltip" data-tooltip="All-up weight including battery">?</span></label>
                            <input type="number" class="form-control" id="totalWeight" value="3.57" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Target T/W Ratio <span class="tooltip" data-tooltip="Thrust-to-Weight ratio (2:1 recommended)">?</span></label>
                            <input type="number" class="form-control" id="twRatio" value="2.0" step="0.1">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Battery Voltage (V)</label>
                            <input type="number" class="form-control" id="batteryVoltage" value="22.2" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Battery Capacity (mAh)</label>
                            <input type="number" class="form-control" id="batteryCapacity" value="12000" step="100">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Battery Chemistry <span class="tooltip" data-tooltip="Affects discharge characteristics">?</span></label>
                        <select class="form-control" id="batteryChemistry">
                            <option value="lipo">LiPo (Lithium Polymer)</option>
                            <option value="liion">Li-ion (Lithium Ion)</option>
                            <option value="life">LiFe (Lithium Iron)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Motor/Propeller Configuration</label>
                        <select class="form-control" id="motorConfig">
                            <option value="tmn3508_1865">T-Motor MN3508 + 1865 Prop</option>
                            <option value="tmn3508_1760">T-Motor MN3508 + 1760 Prop</option>
                            <option value="tmn3508_1660">T-Motor MN3508 + 1660 Prop</option>
                            <option value="generic_small">Generic Small Motor (100-200W)</option>
                            <option value="generic_medium">Generic Medium Motor (200-400W)</option>
                            <option value="generic_large">Generic Large Motor (400-600W)</option>
                            <option value="custom">Custom Motor</option>
                        </select>
                    </div>

                    <div id="customMotorSection" style="display:none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Thrust at Operating Point (g)</label>
                                <input type="number" class="form-control" id="customThrust" value="1800" step="10">
                            </div>
                            <div class="form-group">
                                <label>Power at Operating Point (W)</label>
                                <input type="number" class="form-control" id="customPower" value="200" step="5">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Flight Type <span class="tooltip" data-tooltip="Affects power consumption correction">?</span></label>
                        <select class="form-control" id="flightType">
                            <option value="hover">Pure Hover</option>
                            <option value="photography">Aerial Photography</option>
                            <option value="survey">Survey/Mapping</option>
                            <option value="normal">Normal Flying</option>
                            <option value="aggressive">Aggressive/Sport</option>
                        </select>
                    </div>

                    <button type="button" class="advanced-toggle" onclick="toggleAdvanced()">‚öôÔ∏è Advanced Parameters</button>

                    <div class="advanced-section" id="advancedSection">
                        <div class="form-row">
                            <div class="form-group">
                                <label>ESC Efficiency (%)</label>
                                <input type="number" class="form-control" id="escEfficiency" value="85" min="70" max="95">
                            </div>
                            <div class="form-group">
                                <label>Electronics Power (W)</label>
                                <input type="number" class="form-control" id="electronicsPower" value="5" min="1" max="20">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Battery Losses (W)</label>
                                <input type="number" class="form-control" id="batteryLosses" value="3" min="1" max="15">
                            </div>
                            <div class="form-group">
                                <label>Discharge Limit (%)</label>
                                <input type="number" class="form-control" id="dischargeLimit" value="80" min="60" max="90">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Environmental Factor <span class="tooltip" data-tooltip="Temperature, altitude, wind effects">?</span></label>
                            <select class="form-control" id="environmentalFactor">
                                <option value="1.0">Perfect Conditions</option>
                                <option value="1.1">Good Conditions</option>
                                <option value="1.2">Moderate Conditions</option>
                                <option value="1.3">Poor Conditions</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <div class="results-section">
                <div class="flight-time-display">
                    <div class="flight-time-value" id="flightTimeResult">0.0</div>
                    <div class="flight-time-label">minutes mission time</div>
                </div>

                <div id="warningsContainer"></div>

                <div class="results-tabs">
                    <button class="results-tab active" data-tab="breakdown">üìä Breakdown</button>
                    <button class="results-tab" data-tab="chart">üìà Visual</button>
                    <button class="results-tab" data-tab="calculations">üìã Math</button>
                    <button class="results-tab" data-tab="tips">üí° Tips</button>
                </div>

                <div class="tab-content active" id="breakdown">
                    <div class="power-breakdown" id="powerBreakdown">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="tab-content" id="chart">
                    <div class="chart-container">
                        <canvas id="powerChart"></canvas>
                    </div>
                </div>

                <div class="tab-content" id="calculations">
                    <div id="calculationSteps">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="tab-content" id="tips">
                    <div id="optimizationTips">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="export-section">
                    <button class="export-btn" onclick="exportResults()">üìÑ Export PDF</button>
                    <button class="export-btn" onclick="exportJSON()">üíæ Save Config</button>
                </div>
            </div>
        </div>

        <div class="credit">
            <p>Created by <a href="https://github.com/sidharthmohannair/" target="_blank">Sidharth Mohan Nair</a> | 
            <a href="https://github.com/sidharthmohannair/multirotor-flight-calculator" target="_blank">View Source on GitHub</a></p>
        </div>
    </div>

    <script>
        // Motor database with validated specifications
        const motorDatabase = {
            'tmn3508_1865': {
                name: 'T-Motor MN3508 + 1865 Prop',
                thrustPowerCurve: [
                    { thrust: 840, power: 67.2, throttle: 40 },
                    { thrust: 1260, power: 115.2, throttle: 50 },
                    { thrust: 1755, power: 187.2, throttle: 60 },
                    { thrust: 2170, power: 261.6, throttle: 70 },
                    { thrust: 2675, power: 357.6, throttle: 80 },
                    { thrust: 3010, power: 456, throttle: 90 },
                    { thrust: 3485, power: 571.2, throttle: 100 }
                ],
                testVoltage: 24
            },
            'tmn3508_1760': {
                name: 'T-Motor MN3508 + 1760 Prop',
                thrustPowerCurve: [
                    { thrust: 840, power: 67.2, throttle: 40 },
                    { thrust: 1160, power: 105.6, throttle: 50 },
                    { thrust: 1605, power: 168, throttle: 60 },
                    { thrust: 2065, power: 242.4, throttle: 70 },
                    { thrust: 2545, power: 328.8, throttle: 80 },
                    { thrust: 2940, power: 422.4, throttle: 90 },
                    { thrust: 3345, power: 535.2, throttle: 100 }
                ],
                testVoltage: 24
            },
            'tmn3508_1660': {
                name: 'T-Motor MN3508 + 1660 Prop',
                thrustPowerCurve: [
                    { thrust: 620, power: 50.4, throttle: 40 },
                    { thrust: 970, power: 88.8, throttle: 50 },
                    { thrust: 1330, power: 136.8, throttle: 60 },
                    { thrust: 1725, power: 194.4, throttle: 70 },
                    { thrust: 2110, power: 261.6, throttle: 80 },
                    { thrust: 2540, power: 350.4, throttle: 90 },
                    { thrust: 2945, power: 444, throttle: 100 }
                ],
                testVoltage: 24
            }
        };

        // Flight type correction factors
        const flightCorrections = {
            ideal: {
                hover: 1.0,
                photography: 0.95,
                survey: 0.90,
                normal: 0.85,
                aggressive: 0.75
            },
            realistic: {
                hover: 0.90,
                photography: 0.80,
                survey: 0.67,
                normal: 0.50,
                aggressive: 0.30
            },
            conservative: {
                hover: 0.80,
                photography: 0.70,
                survey: 0.55,
                normal: 0.40,
                aggressive: 0.25
            }
        };

        // Battery discharge factors
        const batteryFactors = {
            lipo: { discharge: 0.80, voltageMultiplier: 1.0 },
            liion: { discharge: 0.85, voltageMultiplier: 0.97 },
            life: { discharge: 0.90, voltageMultiplier: 0.85 }
        };

        let currentChart = null;
        let currentMode = 'beginner';
        let currentCalcMode = 'realistic';

        // Initialize calculator
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            calculate();
        });

        function setupEventListeners() {
            // Mode selectors
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentMode = this.dataset.mode;
                    toggleAdvancedMode();
                });
            });

            document.querySelectorAll('.calc-mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.calc-mode-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentCalcMode = this.dataset.calc;
                    calculate();
                });
            });

            // Results tabs
            document.querySelectorAll('.results-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.results-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                });
            });

            // Form inputs
            document.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('change', calculate);
                input.addEventListener('input', calculate);
            });

            // Aircraft type change
            document.getElementById('aircraftType').addEventListener('change', function() {
                document.getElementById('customMotorGroup').style.display = 
                    this.value === 'custom' ? 'block' : 'none';
                calculate();
            });

            // Motor config change
            document.getElementById('motorConfig').addEventListener('change', function() {
                document.getElementById('customMotorSection').style.display = 
                    this.value === 'custom' ? 'block' : 'none';
                calculate();
            });
        }

        function toggleAdvancedMode() {
            const advancedInputs = document.querySelectorAll('.advanced-section input, .advanced-section select');
            if (currentMode === 'beginner') {
                document.getElementById('advancedSection').classList.remove('show');
                document.querySelector('.advanced-toggle').style.display = 'block';
            } else {
                document.getElementById('advancedSection').classList.add('show');
                document.querySelector('.advanced-toggle').style.display = 'none';
            }
        }

        function toggleAdvanced() {
            document.getElementById('advancedSection').classList.toggle('show');
        }

        function interpolateMotorPower(motorData, requiredThrust, batteryVoltage) {
            const curve = motorData.thrustPowerCurve;
            const voltageCorrection = Math.pow(batteryVoltage / motorData.testVoltage, 2);
            
            // Adjust thrust curve for voltage
            const adjustedCurve = curve.map(point => ({
                thrust: point.thrust * voltageCorrection,
                power: point.power * voltageCorrection
            }));

            // Find interpolation points
            for (let i = 0; i < adjustedCurve.length - 1; i++) {
                if (requiredThrust >= adjustedCurve[i].thrust && requiredThrust <= adjustedCurve[i + 1].thrust) {
                    const t = (requiredThrust - adjustedCurve[i].thrust) / 
                             (adjustedCurve[i + 1].thrust - adjustedCurve[i].thrust);
                    return adjustedCurve[i].power + t * (adjustedCurve[i + 1].power - adjustedCurve[i].power);
                }
            }

            // Extrapolation
            if (requiredThrust < adjustedCurve[0].thrust) {
                return adjustedCurve[0].power * (requiredThrust / adjustedCurve[0].thrust);
            } else {
                const lastPoint = adjustedCurve[adjustedCurve.length - 1];
                return lastPoint.power * (requiredThrust / lastPoint.thrust);
            }
        }

        function calculate() {
            try {
                const inputs = getInputs();
                const results = performCalculation(inputs);
                displayResults(results, inputs);
            } catch (error) {
                console.error('Calculation error:', error);
                displayError('Calculation error. Please check your inputs.');
            }
        }

        function getInputs() {
            const aircraftType = document.getElementById('aircraftType').value;
            const motorCount = aircraftType === 'custom' ? 
                parseInt(document.getElementById('customMotorCount').value) : 
                parseInt(aircraftType);

            return {
                motorCount: motorCount,
                totalWeight: parseFloat(document.getElementById('totalWeight').value),
                twRatio: parseFloat(document.getElementById('twRatio').value),
                batteryVoltage: parseFloat(document.getElementById('batteryVoltage').value),
                batteryCapacity: parseFloat(document.getElementById('batteryCapacity').value),
                batteryChemistry: document.getElementById('batteryChemistry').value,
                motorConfig: document.getElementById('motorConfig').value,
                customThrust: parseFloat(document.getElementById('customThrust').value) || 0,
                customPower: parseFloat(document.getElementById('customPower').value) || 0,
                flightType: document.getElementById('flightType').value,
                escEfficiency: parseFloat(document.getElementById('escEfficiency').value) / 100,
                electronicsPower: parseFloat(document.getElementById('electronicsPower').value),
                batteryLosses: parseFloat(document.getElementById('batteryLosses').value),
                dischargeLimit: parseFloat(document.getElementById('dischargeLimit').value) / 100,
                environmentalFactor: parseFloat(document.getElementById('environmentalFactor').value)
            };
        }

        function performCalculation(inputs) {
            // Step 1: Battery Energy
            const batteryFactor = batteryFactors[inputs.batteryChemistry];
            const adjustedVoltage = inputs.batteryVoltage * batteryFactor.voltageMultiplier;
            const totalEnergy = adjustedVoltage * (inputs.batteryCapacity / 1000); // Wh
            const usableEnergy = totalEnergy * inputs.dischargeLimit;

            // Step 2: Thrust Requirements
            const totalThrust = inputs.totalWeight * inputs.twRatio * 1000; // grams
            const thrustPerMotor = totalThrust / inputs.motorCount;

            // Step 3: Motor Power
            let motorPower;
            if (inputs.motorConfig === 'custom') {
                motorPower = inputs.customPower;
            } else if (motorDatabase[inputs.motorConfig]) {
                motorPower = interpolateMotorPower(
                    motorDatabase[inputs.motorConfig], 
                    thrustPerMotor, 
                    inputs.batteryVoltage
                );
            } else {
                // Generic motor estimation
                motorPower = estimateGenericMotorPower(inputs.motorConfig, thrustPerMotor);
            }

            const totalMotorPower = motorPower * inputs.motorCount;

            // Step 4: System Losses
            const escLosses = totalMotorPower * (1 - inputs.escEfficiency);
            const electronicsPower = inputs.electronicsPower;
            const batteryLosses = inputs.batteryLosses;

            // Step 5: Total System Power
            const totalSystemPower = totalMotorPower + escLosses + electronicsPower + batteryLosses;
            const adjustedPower = totalSystemPower * inputs.environmentalFactor;

            // Step 6: Flight Time
            const theoreticalHoverTime = usableEnergy / adjustedPower * 60; // minutes
            const flightCorrection = flightCorrections[currentCalcMode][inputs.flightType];
            const realFlightTime = theoreticalHoverTime * flightCorrection;

            return {
                batteryEnergy: totalEnergy,
                usableEnergy: usableEnergy,
                thrustPerMotor: thrustPerMotor,
                motorPower: motorPower,
                totalMotorPower: totalMotorPower,
                escLosses: escLosses,
                electronicsPower: electronicsPower,
                batteryLosses: batteryLosses,
                totalSystemPower: totalSystemPower,
                adjustedPower: adjustedPower,
                theoreticalHoverTime: theoreticalHoverTime,
                flightCorrection: flightCorrection,
                realFlightTime: realFlightTime,
                twRatio: inputs.twRatio,
                currentDraw: adjustedPower / adjustedVoltage
            };
        }

        function estimateGenericMotorPower(motorType, thrust) {
            const efficiencyMap = {
                'generic_small': 8,   // g/W
                'generic_medium': 6,  // g/W
                'generic_large': 5    // g/W
            };
            
            const efficiency = efficiencyMap[motorType] || 6;
            return thrust / efficiency;
        }

        function displayResults(results, inputs) {
            // Update flight time display
            document.getElementById('flightTimeResult').textContent = results.realFlightTime.toFixed(1);

            // Update power breakdown
            updatePowerBreakdown(results);

            // Update chart
            updateChart(results);

            // Update calculation steps
            updateCalculationSteps(results, inputs);

            // Update optimization tips
            updateOptimizationTips(results, inputs);

            // Update warnings
            updateWarnings(results, inputs);
        }

        function updatePowerBreakdown(results) {
            const breakdown = document.getElementById('powerBreakdown');
            breakdown.innerHTML = `
                <div class="breakdown-item">
                    <span>Motor Power (${results.totalMotorPower.toFixed(0)}W)</span>
                    <span>${((results.totalMotorPower / results.totalSystemPower) * 100).toFixed(1)}%</span>
                </div>
                <div class="breakdown-item">
                    <span>ESC Losses (${results.escLosses.toFixed(0)}W)</span>
                    <span>${((results.escLosses / results.totalSystemPower) * 100).toFixed(1)}%</span>
                </div>
                <div class="breakdown-item">
                    <span>Electronics (${results.electronicsPower.toFixed(0)}W)</span>
                    <span>${((results.electronicsPower / results.totalSystemPower) * 100).toFixed(1)}%</span>
                </div>
                <div class="breakdown-item">
                    <span>Battery Losses (${results.batteryLosses.toFixed(0)}W)</span>
                    <span>${((results.batteryLosses / results.totalSystemPower) * 100).toFixed(1)}%</span>
                </div>
                <div class="breakdown-item">
                    <span>Total System Power</span>
                    <span>${results.totalSystemPower.toFixed(0)}W</span>
                </div>
            `;
        }

        function updateChart(results) {
            const ctx = document.getElementById('powerChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }

            currentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Motor Power', 'ESC Losses', 'Electronics', 'Battery Losses'],
                    datasets: [{
                        data: [
                            results.totalMotorPower,
                            results.escLosses,
                            results.electronicsPower,
                            results.batteryLosses
                        ],
                        backgroundColor: [
                            '#007bff',
                            '#dc3545',
                            '#ffc107',
                            '#28a745'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateCalculationSteps(results, inputs) {
            const steps = document.getElementById('calculationSteps');
            steps.innerHTML = `
                <div style="font-family: monospace; font-size: 14px; line-height: 1.6;">
                    <h4>Step 1: Battery Energy</h4>
                    <p>Total Energy = ${inputs.batteryVoltage}V √ó ${inputs.batteryCapacity/1000}Ah = ${results.batteryEnergy.toFixed(1)}Wh</p>
                    <p>Usable Energy = ${results.batteryEnergy.toFixed(1)}Wh √ó ${(inputs.dischargeLimit*100).toFixed(0)}% = ${results.usableEnergy.toFixed(1)}Wh</p>
                    
                    <h4>Step 2: Thrust Requirements</h4>
                    <p>Total Thrust = ${inputs.totalWeight}kg √ó ${inputs.twRatio}:1 = ${(inputs.totalWeight * inputs.twRatio).toFixed(2)}kg</p>
                    <p>Thrust per Motor = ${(inputs.totalWeight * inputs.twRatio * 1000).toFixed(0)}g √∑ ${inputs.motorCount} = ${results.thrustPerMotor.toFixed(0)}g</p>
                    
                    <h4>Step 3: Motor Power</h4>
                    <p>Power per Motor = ${results.motorPower.toFixed(1)}W (from specifications)</p>
                    <p>Total Motor Power = ${results.motorPower.toFixed(1)}W √ó ${inputs.motorCount} = ${results.totalMotorPower.toFixed(0)}W</p>
                    
                    <h4>Step 4: System Losses</h4>
                    <p>ESC Losses = ${results.totalMotorPower.toFixed(0)}W √ó ${((1-inputs.escEfficiency)*100).toFixed(0)}% = ${results.escLosses.toFixed(0)}W</p>
                    <p>Electronics = ${results.electronicsPower.toFixed(0)}W</p>
                    <p>Battery Losses = ${results.batteryLosses.toFixed(0)}W</p>
                    
                    <h4>Step 5: Flight Time</h4>
                    <p>Total System Power = ${results.totalSystemPower.toFixed(0)}W</p>
                    <p>Theoretical Hover = ${results.usableEnergy.toFixed(1)}Wh √∑ ${results.totalSystemPower.toFixed(0)}W = ${results.theoreticalHoverTime.toFixed(1)} min</p>
                    <p>Flight Correction = ${(results.flightCorrection*100).toFixed(0)}% (${currentCalcMode} ${inputs.flightType})</p>
                    <p><strong>Real Flight Time = ${results.realFlightTime.toFixed(1)} minutes</strong></p>
                </div>
            `;
        }

        function updateOptimizationTips(results, inputs) {
            const tips = document.getElementById('optimizationTips');
            let tipsList = [];

            if (results.twRatio > 3) {
                tipsList.push("‚ö†Ô∏è High T/W ratio (>3:1) reduces efficiency. Consider reducing thrust for longer flight times.");
            }

            if (results.realFlightTime < 10) {
                tipsList.push("üîã Short flight time detected. Consider larger battery or more efficient motors.");
            }

            if ((results.escLosses / results.totalSystemPower) > 0.2) {
                tipsList.push("‚ö° High ESC losses (>20%). Upgrade to higher efficiency ESCs for better performance.");
            }

            if (results.thrustPerMotor / results.motorPower < 6) {
                tipsList.push("üöÅ Low motor efficiency detected. Consider different propeller or motor combination.");
            }

            tipsList.push("üí° For maximum flight time, aim for 30-50% motor throttle at hover.");
            tipsList.push("üå°Ô∏è Cold weather can reduce battery capacity by 10-20%.");
            tipsList.push("üéØ Plan missions for 70% of calculated time to maintain safety margins.");

            tips.innerHTML = tipsList.map(tip => `<p style="margin-bottom: 10px;">${tip}</p>`).join('');
        }

        function updateWarnings(results, inputs) {
            const container = document.getElementById('warningsContainer');
            container.innerHTML = '';

            if (results.twRatio < 1.2) {
                container.innerHTML += `
                    <div class="warning danger">
                        <span class="warning-icon">‚ö†Ô∏è</span>
                        <strong>DANGER:</strong> T/W ratio below 1.2:1 may result in inability to maintain altitude or control.
                    </div>
                `;
            }

            if (results.realFlightTime < 5) {
                container.innerHTML += `
                    <div class="warning">
                        <span class="warning-icon">‚ö†Ô∏è</span>
                        <strong>WARNING:</strong> Very short flight time. Double-check your configuration.
                    </div>
                `;
            }

            if (results.currentDraw > 50) {
                container.innerHTML += `
                    <div class="warning">
                        <span class="warning-icon">‚ö†Ô∏è</span>
                        <strong>INFO:</strong> High current draw (${results.currentDraw.toFixed(1)}A). Ensure your ESCs and battery can handle this load.
                    </div>
                `;
            }
        }

        function displayError(message) {
            document.getElementById('flightTimeResult').textContent = 'Error';
            document.getElementById('warningsContainer').innerHTML = `
                <div class="warning danger">
                    <span class="warning-icon">‚ùå</span>
                    ${message}
                </div>
            `;
        }

        function exportResults() {
            const results = JSON.stringify({
                timestamp: new Date().toISOString(),
                inputs: getInputs(),
                results: 'Flight time: ' + document.getElementById('flightTimeResult').textContent + ' minutes',
                calculator: 'Professional Multirotor Flight Time Calculator',
                author: 'Sidharth Mohan Nair'
            }, null, 2);

            const blob = new Blob([results], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'drone-flight-calculation.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportJSON() {
            exportResults();
        }
    </script>
</body>
</html>